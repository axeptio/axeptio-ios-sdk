name: update_dependent_repos

on:
  workflow_dispatch:
    inputs:
      ios_sdk_version:
        description: 'iOS SDK version to update to (e.g., 2.0.11)'
        required: true
        type: string
      dry_run:
        description: 'Run in dry-run mode (skip creating PRs)'
        required: false
        default: false
        type: boolean
  workflow_run:
    workflows: ["deploy_to_cocoapods"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write


jobs:
  get_version:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      has_token: ${{ steps.check_token.outputs.has_token }}
    steps:
      - uses: actions/checkout@v4
        if: github.event_name != 'workflow_dispatch'
        with:
          fetch-depth: 0
      
      - name: Check token availability and permissions
        id: check_token
        env:
          GH_TOKEN_DEPENDENCY_ONLY_IOS: ${{ secrets.GH_TOKEN_DEPENDENCY_ONLY_IOS }}
        run: |
          echo "⚙️ Workflow Settings:"
          echo "  dry_run: ${{ inputs.dry_run }}"
          echo "  ios_sdk_version: ${{ inputs.ios_sdk_version }}"
          echo "  trigger: ${{ github.event_name }}"
          echo ""
          
          if [ -n "$GH_TOKEN_DEPENDENCY_ONLY_IOS" ]; then
            echo "has_token=true" >> "$GITHUB_OUTPUT"
            echo "🔐 GH_TOKEN_DEPENDENCY_ONLY_IOS: [REDACTED] ($(echo -n "$GH_TOKEN_DEPENDENCY_ONLY_IOS" | shasum -a 256 | cut -d' ' -f1))"
            echo ""
            
            echo "🔍 Checking GH_TOKEN_DEPENDENCY_ONLY_IOS permissions..."
            
            # Function to check detailed permissions
            check_repo_permissions() {
              local repo="$1"
              
              echo "📋 Checking GH_TOKEN_DEPENDENCY_ONLY_IOS for $repo..."
              
              if GITHUB_TOKEN="$GH_TOKEN_DEPENDENCY_ONLY_IOS" gh api repos/$repo --silent; then
                echo "✅ GH_TOKEN_DEPENDENCY_ONLY_IOS can access $repo"
                
                # Get detailed permissions
                echo "🔐 Detailed permissions for $repo:"
                PERMS=$(GITHUB_TOKEN="$GH_TOKEN_DEPENDENCY_ONLY_IOS" gh api repos/$repo --jq '.permissions // {}')
                echo "  admin: $(echo "$PERMS" | jq -r '.admin // false')"
                echo "  maintain: $(echo "$PERMS" | jq -r '.maintain // false')"
                echo "  push: $(echo "$PERMS" | jq -r '.push // false')"
                echo "  triage: $(echo "$PERMS" | jq -r '.triage // false')"
                echo "  pull: $(echo "$PERMS" | jq -r '.pull // false')"
                
                # Test specific operations
                echo "🧪 Testing operations:"
                
                # Test if can create branches/push
                if GITHUB_TOKEN="$GH_TOKEN_DEPENDENCY_ONLY_IOS" gh api repos/$repo/git/refs --silent; then
                  echo "  ✅ Can access git refs (push capability likely)"
                else
                  echo "  ❌ Cannot access git refs (no push capability)"
                fi
                
                # Test if can create PRs
                if GITHUB_TOKEN="$GH_TOKEN_DEPENDENCY_ONLY_IOS" gh api repos/$repo/pulls --silent; then
                  echo "  ✅ Can access pull requests"
                else
                  echo "  ❌ Cannot access pull requests"
                fi
                
              else
                echo "❌ GH_TOKEN_DEPENDENCY_ONLY_IOS cannot access $repo"
                echo "  This token needs at least 'Contents: Write' and 'Pull requests: Write' permissions"
              fi
              echo ""
            }
            
            # Check token against all target repositories
            check_repo_permissions "axeptio/sample-app-ios"
            check_repo_permissions "axeptio/flutter-sdk"
            check_repo_permissions "axeptio/react-native-sdk"
            
          else
            echo "has_token=false" >> "$GITHUB_OUTPUT"
            echo "⚠️  GH_TOKEN_DEPENDENCY_ONLY_IOS: Not configured"
          fi
      
      - name: Set version
        id: set_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.ios_sdk_version }}" >> "$GITHUB_OUTPUT"
          else
            git fetch --tags
            VERSION=$(git tag | sort -V | tail -1)
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          fi
          
  update_sample_app:
    needs: get_version
    if: needs.get_version.outputs.has_token == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sample-app-ios
        uses: actions/checkout@v4
        with:
          repository: axeptio/sample-app-ios
          token: ${{ secrets.GH_TOKEN_DEPENDENCY_ONLY_IOS }}
          
      - name: Create branch and update version
        id: update_files
        env:
          IOS_VERSION: ${{ needs.get_version.outputs.version }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Display workflow settings for this job
          echo "⚙️ Job Settings (sample-app-ios):"
          echo "  ios_version: $IOS_VERSION"
          echo "  dry_run: $DRY_RUN"
          echo "  trigger: ${{ github.event_name }}"
          echo ""
          
          # Default to dry-run if no input provided (for automatic triggers)
          if [ -z "$DRY_RUN" ]; then
            DRY_RUN="true"
          fi
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "🧪 Running in DRY-RUN mode - no actual PRs will be created"
          fi
          echo ""
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "🔍 Files before update:"
          ls -la
          
          # Update Podfile
          if [ -f "Podfile" ]; then
            echo "📝 Updating Podfile..."
            echo "Current content:"
            grep -n "AxeptioSDK" Podfile || echo "No AxeptioSDK found in Podfile"
            sed -i.bak "s/pod 'AxeptioSDK', '~> [0-9.]*'/pod 'AxeptioSDK', '~> $IOS_VERSION'/" Podfile
            echo "Updated content:"
            grep -n "AxeptioSDK" Podfile || echo "No AxeptioSDK found in Podfile"
            rm Podfile.bak
          else
            echo "⚠️  Podfile not found"
          fi
          
          # Update Package.swift if it exists
          if [ -f "Package.swift" ]; then
            echo "📝 Updating Package.swift..."
            echo "Current content:"
            grep -n "from:" Package.swift || echo "No version found in Package.swift"
            sed -i.bak "s/from: \"[0-9.]*\"/from: \"$IOS_VERSION\"/" Package.swift
            echo "Updated content:"
            grep -n "from:" Package.swift || echo "No version found in Package.swift"
            rm Package.swift.bak
          else
            echo "⚠️  Package.swift not found"
          fi
          
          # Update Xcode project.pbxproj files for Swift Package Manager
          find . -name "project.pbxproj" -type f | while read -r pbxproj_file; do
            if grep -q "axeptio-ios-sdk" "$pbxproj_file"; then
              echo "📝 Updating $pbxproj_file..."
              echo "Current minimumVersion:"
              grep -n "minimumVersion.*[0-9]\+\.[0-9]\+\.[0-9]\+" "$pbxproj_file" | grep -A5 -B5 "axeptio-ios-sdk" || echo "No minimumVersion found"
              
              # Update minimumVersion for axeptio-ios-sdk package
              sed -i.bak "s/\(minimumVersion = \)[0-9]\+\.[0-9]\+\.[0-9]\+\(.*axeptio-ios-sdk\|.*\n.*axeptio-ios-sdk\)/\1$IOS_VERSION\2/" "$pbxproj_file"
              
              # Alternative pattern in case the structure is different
              sed -i.bak "s/\(minimumVersion = \)[0-9]\+\.[0-9]\+\.[0-9]\+;/\1$IOS_VERSION;/g" "$pbxproj_file"
              
              echo "Updated minimumVersion:"
              grep -n "minimumVersion.*[0-9]\+\.[0-9]\+\.[0-9]\+" "$pbxproj_file" | grep -A5 -B5 "axeptio-ios-sdk" || echo "No minimumVersion found"
              rm "${pbxproj_file}.bak"
            else
              echo "⚠️  $pbxproj_file doesn't contain axeptio-ios-sdk reference"
            fi
          done
          
          echo "🔍 Git diff output:"
          git diff
          echo "🔍 Git diff --staged output:"
          git diff --staged
          
          # Check if there are any changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "❌ No changes detected. Version might already be up to date."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "✅ Changes detected, proceeding with commit"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
          
          BRANCH_NAME="update-ios-sdk-$IOS_VERSION"
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "Update iOS SDK to version $IOS_VERSION"
          
          if [ "$DRY_RUN" != "true" ]; then
            git push origin "$BRANCH_NAME"
          else
            echo "Dry-run: Would push branch $BRANCH_NAME"
          fi
          
      - name: Create Pull Request
        if: inputs.dry_run != true && steps.update_files.outputs.has_changes == 'true' && steps.update_files.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_DEPENDENCY_ONLY_IOS }}
          IOS_VERSION: ${{ needs.get_version.outputs.version }}
        run: |
          BODY="This PR updates the Axeptio iOS SDK to version $IOS_VERSION.
          
          ## Changes
          - Updated iOS SDK version in Podfile, Package.swift, and/or Xcode project files
          
          ## Notes
          This PR was automatically generated when iOS SDK version $IOS_VERSION was published."
          
          gh pr create \
            --title "Update iOS SDK to version $IOS_VERSION" \
            --body "$BODY" \
            --base master \
            --head "update-ios-sdk-$IOS_VERSION"

  update_flutter_sdk:
    needs: get_version
    if: needs.get_version.outputs.has_token == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout flutter-sdk
        uses: actions/checkout@v4
        with:
          repository: axeptio/flutter-sdk
          token: ${{ secrets.GH_TOKEN_DEPENDENCY_ONLY_IOS }}
          
      - name: Create branch and update version
        id: update_files
        env:
          IOS_VERSION: ${{ needs.get_version.outputs.version }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Display workflow settings for this job
          echo "⚙️ Job Settings (flutter-sdk):"
          echo "  ios_version: $IOS_VERSION"
          echo "  dry_run: $DRY_RUN"
          echo "  trigger: ${{ github.event_name }}"
          echo ""
          
          # Default to dry-run if no input provided (for automatic triggers)
          if [ -z "$DRY_RUN" ]; then
            DRY_RUN="true"
          fi
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "🧪 Running in DRY-RUN mode - no actual PRs will be created"
          fi
          echo ""
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "🔍 Files before update:"
          ls -la
          
          # Update pubspec.yaml version (bump patch version of flutter SDK)
          if [ -f "pubspec.yaml" ]; then
            echo "📝 Updating pubspec.yaml version..."
            echo "Current version:"
            grep -n "^version:" pubspec.yaml || echo "No version found in pubspec.yaml"
            
            # Get current flutter SDK version and increment patch version
            CURRENT_FLUTTER_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //')
            echo "Current Flutter SDK version: $CURRENT_FLUTTER_VERSION"
            
            # Split version into components
            IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_FLUTTER_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            
            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_FLUTTER_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
            
            echo "New Flutter SDK version: $NEW_FLUTTER_VERSION"
            sed -i.bak "s/^version: .*/version: $NEW_FLUTTER_VERSION/" pubspec.yaml
            echo "Updated version:"
            grep -n "^version:" pubspec.yaml || echo "No version found in pubspec.yaml"
            rm pubspec.yaml.bak
          else
            echo "⚠️  pubspec.yaml not found"
          fi
          
          # Update ios/axeptio_sdk.podspec
          if [ -f "ios/axeptio_sdk.podspec" ]; then
            echo "📝 Updating ios/axeptio_sdk.podspec..."
            echo "Current content:"
            grep -n "AxeptioSDK" ios/axeptio_sdk.podspec || echo "No AxeptioSDK found in podspec"
            sed -i.bak "s/s.dependency 'AxeptioSDK', '~> [0-9.]*'/s.dependency 'AxeptioSDK', '~> $IOS_VERSION'/" ios/axeptio_sdk.podspec
            echo "Updated content:"
            grep -n "AxeptioSDK" ios/axeptio_sdk.podspec || echo "No AxeptioSDK found in podspec"
            rm ios/axeptio_sdk.podspec.bak
          else
            echo "⚠️  ios/axeptio_sdk.podspec not found"
          fi
          
          echo "🔍 Git diff output:"
          git diff
          echo "🔍 Git diff --staged output:"
          git diff --staged
          
          # Check if there are any changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "❌ No changes detected. Version might already be up to date."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "✅ Changes detected, proceeding with commit"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
          
          BRANCH_NAME="update-ios-sdk-$IOS_VERSION"
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "Update iOS SDK to version $IOS_VERSION and bump Flutter SDK version"
          
          if [ "$DRY_RUN" != "true" ]; then
            git push origin "$BRANCH_NAME"
          else
            echo "Dry-run: Would push branch $BRANCH_NAME"
          fi
          
      - name: Create Pull Request
        if: inputs.dry_run != true && steps.update_files.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_DEPENDENCY_ONLY_IOS }}
          IOS_VERSION: ${{ needs.get_version.outputs.version }}
        run: |
          BODY="This PR updates the Axeptio iOS SDK to version $IOS_VERSION.
          
          ## Changes
          - Updated iOS SDK dependency in ios/axeptio_sdk.podspec
          - Bumped Flutter SDK version in pubspec.yaml
          
          ## Notes
          This PR was automatically generated when iOS SDK version $IOS_VERSION was published."
          
          gh pr create \
            --title "Update iOS SDK to version $IOS_VERSION" \
            --body "$BODY" \
            --base master \
            --head "update-ios-sdk-$IOS_VERSION"

  update_react_native_sdk:
    needs: get_version
    if: needs.get_version.outputs.has_token == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout react-native-sdk
        uses: actions/checkout@v4
        with:
          repository: axeptio/react-native-sdk
          token: ${{ secrets.GH_TOKEN_DEPENDENCY_ONLY_IOS }}
          
      - name: Create branch and update version
        id: update_files
        env:
          IOS_VERSION: ${{ needs.get_version.outputs.version }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Display workflow settings for this job
          echo "⚙️ Job Settings (react-native-sdk):"
          echo "  ios_version: $IOS_VERSION"
          echo "  dry_run: $DRY_RUN"
          echo "  trigger: ${{ github.event_name }}"
          echo ""
          
          # Default to dry-run if no input provided (for automatic triggers)
          if [ -z "$DRY_RUN" ]; then
            DRY_RUN="true"
          fi
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "🧪 Running in DRY-RUN mode - no actual PRs will be created"
          fi
          echo ""
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "🔍 Files before update:"
          ls -la
          
          # Update react-native-axeptio-sdk.podspec (bump its own version first)
          if [ -f "react-native-axeptio-sdk.podspec" ]; then
            echo "📝 Updating react-native-axeptio-sdk.podspec version..."
            
            # Get current React Native SDK version and increment patch version
            CURRENT_RN_VERSION=$(grep "s.version" react-native-axeptio-sdk.podspec | sed 's/.*"\([0-9.]*\)".*/\1/')
            echo "Current React Native SDK version: $CURRENT_RN_VERSION"
            
            # Split version into components
            IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_RN_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            
            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_RN_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
            
            echo "New React Native SDK version: $NEW_RN_VERSION"
            sed -i.bak "s/s.version.*=.*/s.version          = \"$NEW_RN_VERSION\"/" react-native-axeptio-sdk.podspec
            
            echo "📝 Updating AxeptioIOSSDK dependency..."
            echo "Current iOS dependency:"
            grep -n "AxeptioIOSSDK" react-native-axeptio-sdk.podspec || echo "No AxeptioIOSSDK found in podspec"
            
            # Update the AxeptioIOSSDK dependency (note: uses fixed version, not ~>)
            sed -i.bak "s/s.dependency \"AxeptioIOSSDK\", \"[0-9.]*\"/s.dependency \"AxeptioIOSSDK\", \"$IOS_VERSION\"/" react-native-axeptio-sdk.podspec
            
            echo "Updated content:"
            grep -n "s.version\|AxeptioIOSSDK" react-native-axeptio-sdk.podspec || echo "No version/dependency found"
            rm react-native-axeptio-sdk.podspec.bak
          else
            echo "⚠️  react-native-axeptio-sdk.podspec not found"
          fi
          
          # Also update package.json version if it exists
          if [ -f "package.json" ]; then
            echo "📝 Updating package.json version..."
            echo "Current version:"
            grep -n "\"version\":" package.json || echo "No version found in package.json"
            
            # Use the same incremented version as the podspec
            if [ -n "$NEW_RN_VERSION" ]; then
              sed -i.bak "s/\"version\": \"[0-9.]*\"/\"version\": \"$NEW_RN_VERSION\"/" package.json
              echo "Updated version:"
              grep -n "\"version\":" package.json || echo "No version found in package.json"
              rm package.json.bak
            fi
          else
            echo "⚠️  package.json not found"
          fi
          
          echo "🔍 Git diff output:"
          git diff
          echo "🔍 Git diff --staged output:"
          git diff --staged
          
          # Check if there are any changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "❌ No changes detected. Version might already be up to date."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "✅ Changes detected, proceeding with commit"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi
          
          BRANCH_NAME="update-ios-sdk-$IOS_VERSION"
          git checkout -b "$BRANCH_NAME"
          git add -A
          git commit -m "Update iOS SDK to version $IOS_VERSION and bump React Native SDK version"
          
          if [ "$DRY_RUN" != "true" ]; then
            git push origin "$BRANCH_NAME"
          else
            echo "Dry-run: Would push branch $BRANCH_NAME"
          fi
          
      - name: Create Pull Request
        if: inputs.dry_run != true && steps.update_files.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_DEPENDENCY_ONLY_IOS }}
          IOS_VERSION: ${{ needs.get_version.outputs.version }}
        run: |
          BODY="This PR updates the Axeptio iOS SDK to version $IOS_VERSION.
          
          ## Changes
          - Updated AxeptioIOSSDK dependency in react-native-axeptio-sdk.podspec
          - Bumped React Native SDK version in podspec and package.json
          
          ## Notes
          This PR was automatically generated when iOS SDK version $IOS_VERSION was published."
          
          gh pr create \
            --title "Update iOS SDK to version $IOS_VERSION" \
            --body "$BODY" \
            --base master \
            --head "update-ios-sdk-$IOS_VERSION"
  notify_missing_credentials:
    needs: get_version
    if: needs.get_version.outputs.has_token == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Notify about missing credentials
        run: |
          echo "⚠️  WARNING: GH_TOKEN_DEPENDENCY_ONLY_IOS is not configured"
          echo ""
          echo "The update_dependent_repos workflow requires a GitHub token with appropriate permissions to create PRs in other repositories."
          echo ""
          echo "To enable automatic updates of dependent repositories, please configure this secret:"
          echo "  - GH_TOKEN_DEPENDENCY_ONLY_IOS: GitHub token with 'Contents: Write' and 'Pull requests: Write' permissions"
          echo ""
          echo "Without this token, the workflow cannot:"
          echo "  - Update axeptio/sample-app-ios"
          echo "  - Update axeptio/flutter-sdk"
          echo "  - Update axeptio/react-native-sdk"
          echo ""
          echo "iOS SDK version that would have been used: ${{ needs.get_version.outputs.version }}"