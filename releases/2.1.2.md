# Release 2.1.2

**Release Date:** December 17, 2025
**Type:** Patch Release
**GitHub Release:** https://github.com/axeptio/axeptio-ios-sdk/releases/tag/2.1.2

## Overview

Version 2.1.2 is a critical bug fix release that addresses a consent persistence regression where the cookie banner would display on every app launch, even after users had already provided consent. This release also includes sample app improvements and CI/CD enhancements.

## Bug Fixes

### MSK-136: Consent Duration Persistence

**Issue:** Cookie banner displays on every app launch, even after users accept consent.

**Impact:** All users on SDK versions 2.1.0 and 2.1.1 who are not explicitly setting `shouldUpdateCookiesDuration = true`. This affected the vast majority of integrations using default settings.

**Root Cause:** When `shouldUpdateCookiesDuration` defaulted to `false`, the consent duration end date was only persisted during SDK initialization, not when consent was saved via the widget. The `hasConsentExpired()` method would always return `true` because no persisted duration end date existed, causing the banner to display on every launch.

**Technical Details:**

The SDK's consent expiration check in `AxeptioViewModel.swift` worked as follows:

1. User accepts consent via widget
2. SDK receives `consent:saved` event
3. Consent choices are persisted to local storage
4. **Missing step:** Duration end date was NOT persisted
5. On next app launch, `hasConsentExpired()` checks for persisted duration end date
6. No end date found → returns `true` → banner displays again

**Solution:** The SDK now persists the consent duration end date whenever consent is saved, regardless of the `shouldUpdateCookiesDuration` setting. This ensures proper consent persistence for all users.

Changes made to `AxeptioViewModel.swift`:
- Added duration persistence in `consent:saved` event handler (lines 376-380)
- Ensures `persistCookiesDurationEndDate()` is called when consent is saved
- Added comprehensive unit tests to verify the fix

**Testing:**
- Added 5 new unit tests specifically for duration persistence
- Total test suite: 19 tests, all passing
- Tests cover various scenarios: default settings, explicit updates, app launches

**Related:** [PR #73](https://github.com/axeptio/axeptio-ios-sdk-sources/pull/73), Linear MSK-136

### Sample App: Configuration Default Fix

**Issue:** Sample app's ConfigurationManager returned 0 for `cookiesDuration` when UserDefaults key didn't exist, causing consent to expire immediately.

**Root Cause:** Using `userDefaults.integer(forKey:)` which returns 0 when the key doesn't exist in UserDefaults, instead of providing a proper default value.

**Solution:** Changed ConfigurationManager.swift line 129 to use `userDefaults.object(forKey:) as? Int ?? 190` to provide the correct 190-day default value.

**Impact:** Sample app now correctly demonstrates SDK behavior with proper default values.

**Related:** [PR #74](https://github.com/axeptio/axeptio-ios-sdk-sources/pull/74), commit `1347779`

## Improvements

### Code Coverage Reporting

**Enhancement:** Enabled code coverage reporting in the CI/CD pipeline.

**Changes:**
- Updated `.github/workflows/unit-test.yml` to enable coverage reporting
- Updated `AxeptioSDK.xcscheme` to enable code coverage collection
- Coverage metrics now displayed in GitHub Actions summaries for all PRs

**Benefit:** Improved visibility into test coverage for code quality assurance.

**Related:** Commit `3cd266c`

## Migration Guide

### Updating Your Integration

Version 2.1.2 is fully backward compatible with 2.1.0 and 2.1.1. No code changes are required.

Simply update your dependency to version 2.1.2:

**Swift Package Manager:**
```swift
.package(url: "https://github.com/axeptio/axeptio-ios-sdk", from: "2.1.2")
```

**CocoaPods:**
```ruby
pod 'AxeptioIOSSDK', '~> 2.1.2'
```

### Important Note for Existing Users

Users who have already accepted consent on versions 2.1.0 or 2.1.1 will need to accept consent one more time after updating to 2.1.2, as the previous consent duration may not have persisted correctly. After this one-time re-acceptance, consent will persist properly according to your configured `cookiesDurationDays` (default: 190 days).

### Verifying the Fix

**Consent Persistence:**
1. Update to version 2.1.2
2. Launch your app and accept the consent widget
3. Close the widget
4. Force quit and relaunch the app
5. Verify the consent banner does NOT display on subsequent launches
6. Check logs for: `✅ Cookies duration end date persisted` with correct day count

**Expected Behavior:**
- First launch: Widget displays (if no prior consent)
- Accept consent: Widget closes
- Subsequent launches: Widget does not display (unless consent expired)
- Re-opening widget manually: Use `Axeptio.shared.showConsentScreen()` in settings

## Installation

### Swift Package Manager

Update your `Package.swift`:

```swift
dependencies: [
    .package(url: "https://github.com/axeptio/axeptio-ios-sdk", from: "2.1.2")
]
```

Or update via Xcode:

1. File > Packages > Update to Latest Package Versions
2. Verify version 2.1.2 is installed

### CocoaPods

Update your `Podfile`:

```ruby
pod 'AxeptioIOSSDK', '~> 2.1.2'
```

Then run:

```bash
pod update AxeptioIOSSDK
```

## Related Resources

- **Documentation:** [README.md](../README.md)
- **Sample App:** [sample-app-ios](https://github.com/axeptio/sample-app-ios)
- **GitHub Release:** [v2.1.2](https://github.com/axeptio/axeptio-ios-sdk/releases/tag/2.1.2)
- **Issues:** [GitHub Issues](https://github.com/axeptio/axeptio-ios-sdk-sources/issues)
- **Linear Ticket:** [MSK-136](https://linear.app/axeptio/issue/MSK-136)

## Technical Details

**Commits:** 3 commits from develop branch

**Related Pull Requests:**
- [PR #73](https://github.com/axeptio/axeptio-ios-sdk-sources/pull/73) - MSK-136 fix and unit tests
- [PR #74](https://github.com/axeptio/axeptio-ios-sdk-sources/pull/74) - Sample app fix and release

**Commits:**
- `d056d16` - fix(sdk-integration): persist consent duration on consent:saved event
- `3cd266c` - chore(tests): enable code coverage reporting in ci/cd
- `1347779` - fix(sample-swift): use 190-day default for cookie duration

**Files Modified:**
- `AxeptioSDK/Internal/AxeptioViewModel.swift` - Consent duration persistence
- `AxeptioSDKTests/AxeptioViewModelTests.swift` - Added 5 unit tests
- `sampleSwift/ConfigurationManager.swift` - Fixed default value
- `.github/workflows/unit-test.yml` - Code coverage reporting
- `AxeptioSDK.xcscheme` - Enabled code coverage

**Related Issues:**
- MSK-136: Consent duration persistence regression

**Full Comparison:** [2.1.1...2.1.2](https://github.com/axeptio/axeptio-ios-sdk/compare/2.1.1...2.1.2)
